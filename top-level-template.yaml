AWSTemplateFormatVersion: "2010-09-09"
Description: Top-level stack template that deploys a complete CI/CD pipeline with ECR, ECS, CodeBuild, VPC components and RDS.

Parameters:
  VpcCidr: { Type: String }
  PrivateRouteTableId: { Type: String }
  PrivateSubnetIds: { Type: CommaDelimitedList }
  AppName: { Type: String, Default: GalleryApp-v2 }
  VpcCidr: { Type: String, Default: 10.0.0.0/16 }
  PublicSubnetCidr1: { Type: String, Default: 10.0.1.0/24 }
  PublicSubnetCidr2: { Type: String, Default: 10.0.2.0/24 }
  PrivateSubnetCidr1: { Type: String, Default: 10.0.3.0/24 }
  PrivateSubnetCidr2: { Type: String, Default: 10.0.4.0/24 }
  PrivateSubnetCidrs: { Type: CommaDelimitedList }
  PublicSubnetCidrs: { Type: CommaDelimitedList }
  ProjectTag: { Type: String, Default: "week6-lab1" }
  ECRImageTag: { Type: String, Default: latest }
  ECSServiceName: { Type: String, Default: GalleryXPAppService }

Resources:
  NetworkStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/my-bucket/vpc-template.yaml
      Parameters:
        AppName: !Ref AppName
        VpcCidr: !Ref VpcCidr
        PublicSubnetCidrs: !Join [',', !Ref PublicSubnetCidrs]
        PrivateSubnetCidrs: !Join [',', !Ref PrivateSubnetCidrs]
        ProjectTag: !Ref ProjectTag
      
  # Include the RDS stack
  RDSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: /path_to_template/rds-template.yaml
      Parameters:
        VpcId: !GetAtt NetworkStack.Outputs.VpcId
        PrivateSubnetIds: !GetAtt NetworkStack.Outputs.PrivateSubnetIds
        DBSecurityGroup: !GetAtt NetworkStack.Outputs.DBSecurityGroup
        AppName: !Ref AppName

  # Include the IAM stack
  IAMStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./templates/iam-template.yaml
      Parameters:
        PipelineName: !Ref PipelineName
        ProjectTag: !Ref ProjectTag
        AppName: !Ref AppName

  S3Stack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./templates/s3-template.yaml
      Parameters:
        AppName: !Ref AppName
        ALBDnsName: !GetAtt NetworkStack.Outputs.ALBDnsName
        ECSTaskRoleArn: !GetAtt IAMStack.Outputs.ECSTaskRoleArn


  # Include ECS Stack
  ECSStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: ./templates/ecs-template.yaml
      Parameters:
        AppName: !Ref AppName
        ALBSecurityGroup: !GetAtt NetworkStack.Outputs.ALBSecurityGroup
        PrivateSubnetIds: !GetAtt NetworkStack.Outputs.PrivateSubnetIds
        PublicSubnetIds: !GetAtt NetworkStack.Outputs.PublicSubnetIds
        ECRImageTag: !Ref ECRImageTag
        ECSServiceName: !Ref ECSServiceName
        ProjectTag: !Ref ProjectTag 
        

  # Include the CI/CD stack
  CICDStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: https://s3.amazonaws.com/my-bucket/ci-cd-template.yaml
      Parameters:
        PipelineName: !Ref PipelineName

  CodeDeployStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: ECSStack
    Properties:
      TemplateURL: !Sub ${TemplatesURL}codedeploy.yaml
      Parameters:
        AppName: !Ref AppName
        ECSClusterName: !GetAtt ECSStack.Outputs.ECSClusterName
        ECSServiceName: !GetAtt ECSStack.Outputs.ECSServiceName
        BlueTargetGroupName: !GetAtt ECSStack.Outputs.BlueTargetGroupName
        GreenTargetGroupName: !GetAtt ECSStack.Outputs.GreenTargetGroupName
        AlbListenerArn: !GetAtt ECSStack.Outputs.ALBListenerArn
        CodeDeployRoleArn: !GetAtt IAMStack.Outputs.CodeDeployRoleArn
        ProjectTag: !Ref ProjectTag

  CodePipelineStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: [ECSStack, CodeDeployStack, S3Stack]
    Properties:
      TemplateURL: !Sub ${TemplatesURL}codepipeline.yaml
      Parameters:
        ECSAppName: !Ref ECSAppName
        ECRRepoName: !GetAtt ECSStack.Outputs.ECRRepoName
        ContainerName: !Ref ContainerName
        ContainerPort: !Ref ContainerPort
        TaskDefinitionArn: !GetAtt ECSStack.Outputs.TaskDefinitionArn
        CodeDeployApplication: !GetAtt CodeDeployStack.Outputs.CodeDeployApplicationName
        ArtifactsBucketName: !GetAtt S3Stack.Outputs.ArtifactsBucketName
        ECSClusterName: !GetAtt ECSStack.Outputs.ECSClusterName
        ECSServiceName: !GetAtt ECSStack.Outputs.ECSServiceName

  EventBridgeStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: PipelineStack
    Properties:
      TemplateURL: !Sub ${TemplatesURL}eventbridge.yaml
      Parameters:
        ECRRepoArn: !GetAtt ECSStack.Outputs.ECRRepoArn
        PipelineName: !GetAtt CodePipelineStack.Outputs.BlueGreenDeploymentPipeline

Outputs:
  LoadBalancerDNS:
    Value: !GetAtt ALBStack.Outputs.ALBDnsName
  S3BucketName:
    Value: !GetAtt S3Stack.Outputs.S3BucketName
  RDSSecretArn:
    Value: !GetAtt RDSStack.Outputs.DBSecretArn
  ECRRepoURI:
    Value: !GetAtt ECSStack.Outputs.ECRRepoURI